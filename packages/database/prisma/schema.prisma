generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "debian-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// MULTI-TENANCY: GYM
// ============================================

model Gym {
  id              String   @id @default(cuid())
  name            String
  slug            String   @unique
  email           String
  phone           String?
  address         String?
  timezone        String   @default("UTC")
  currency        String   @default("USD")
  logoUrl         String?
  settings        Json     @default("{}")

  // Branding
  tagline           String?
  description       String?     @db.Text
  coverImageUrl     String?

  // Theme colors
  primaryColor      String?     @default("#6366f1")
  secondaryColor    String?     @default("#f1f5f9")
  accentColor       String?     @default("#10b981")

  // Social links
  websiteUrl        String?
  facebookUrl       String?
  instagramUrl      String?

  // Stripe Connect
  stripeAccountId           String?  @unique
  stripeAccountStatus       String?  @default("pending") // pending, onboarding, active, restricted
  stripeChargesEnabled      Boolean  @default(false)
  stripePayoutsEnabled      Boolean  @default(false)
  stripePlatformFeePercent  Decimal  @default(2.5) @db.Decimal(5, 2)
  stripeOnboardingComplete  Boolean  @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  members              Member[]
  staff                Staff[]
  membershipPlans      MembershipPlan[]
  classes              Class[]
  classSessions        ClassSession[]
  checkIns             CheckIn[]
  tags                 Tag[]
  payments             Payment[]
  invoices             Invoice[]
  expenses             Expense[]
  payouts              Payout[]
  automatedFlows       AutomatedFlow[]
  campaigns            Campaign[]
  refunds              Refund[]
  products             Product[]
  purchases            Purchase[]
  failedPayments       FailedPaymentAttempt[]
  payrollPeriods       PayrollPeriod[]
  openingHours         OpeningHours[]
  policies             GymPolicy[]
  opportunities        Opportunity[]
  memberPasses         MemberPass[]
  bonusBalances            BonusBalance[]
  bonusBalanceTransactions BonusBalanceTransaction[]

  // Canadian Accounting Compliance
  taxConfiguration     TaxConfiguration?
  businessInfo         BusinessInfo?
  currencySettings     CurrencySettings?

  @@index([slug])
}

// ============================================
// USERS & AUTHENTICATION
// ============================================

model User {
  id            String    @id @default(cuid())
  email         String    @unique
  emailVerified DateTime?
  passwordHash  String

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  member   Member?
  staff    Staff?
  sessions Session[]

  @@index([email])
}

model Session {
  id        String   @id @default(cuid())
  userId    String
  token     String   @unique
  expiresAt DateTime

  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([token])
}

model PasswordResetToken {
  id        String   @id @default(cuid())
  email     String
  token     String   @unique
  expiresAt DateTime

  createdAt DateTime @default(now())

  @@index([email])
  @@index([token])
}

// ============================================
// MEMBERS
// ============================================

model Member {
  id String @id @default(cuid())

  // Profile
  firstName        String
  lastName         String
  email            String
  phone            String?
  dateOfBirth      DateTime?
  avatarUrl        String?
  emergencyContact Json? // { name, phone, relation }
  notes            String?

  // Status
  status   MemberStatus @default(ACTIVE)
  joinedAt DateTime     @default(now())

  // Billing
  stripeCustomerId String? @unique

  // Relations
  userId String @unique
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  gymId  String
  gym    Gym    @relation(fields: [gymId], references: [id], onDelete: Cascade)

  subscription       Subscription?
  bookings           Booking[]
  checkIns           CheckIn[]
  waitlistEntries    WaitlistEntry[]
  tags               MemberTag[]
  payments           Payment[]
  invoices           Invoice[]
  purchases          Purchase[]
  failedPayments     FailedPaymentAttempt[]
  opportunities      Opportunity[]
  passes             MemberPass[]
  bonusBalance             BonusBalance?
  bonusBalanceTransactions BonusBalanceTransaction[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([gymId, email])
  @@index([gymId])
  @@index([status])
}

enum MemberStatus {
  PENDING
  ACTIVE
  PAUSED
  CANCELLED
  EXPIRED
}

// ============================================
// STAFF
// ============================================

model Staff {
  id String @id @default(cuid())

  firstName String
  lastName  String
  email     String
  phone     String?
  role      StaffRole
  avatarUrl String?

  // Profile (for public trainer pages)
  bio             String?     @db.Text
  specialties     String[]    @default([])
  certifications  String[]    @default([])
  instagramUrl    String?
  linkedinUrl     String?
  isPublicProfile Boolean     @default(true)

  // Employment
  hireDate   DateTime @default(now())
  hourlyRate Decimal? @db.Decimal(10, 2)
  isActive   Boolean  @default(true)

  // Relations
  userId String @unique
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  gymId  String
  gym    Gym    @relation(fields: [gymId], references: [id], onDelete: Cascade)

  instructorClasses Class[] @relation("ClassInstructor")
  expenses          Expense[]
  refundsProcessed  Refund[]
  payrollEntries    PayrollEntry[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([gymId, email])
  @@index([gymId])
  @@index([role])
}

enum StaffRole {
  OWNER
  ADMIN
  MANAGER
  INSTRUCTOR
  FRONT_DESK
}

// ============================================
// MEMBERSHIP PLANS & SUBSCRIPTIONS
// ============================================

model MembershipPlan {
  id String @id @default(cuid())

  name        String
  description String?

  // Pricing
  priceAmount     Decimal         @db.Decimal(10, 2)
  priceCurrency   String          @default("USD")
  billingInterval BillingInterval

  // Features
  classCredits Int?     @default(-1) // -1 = unlimited
  guestPasses  Int      @default(0)
  features     String[] @default([])

  // Stripe
  stripePriceId   String?
  stripeProductId String?

  // Status
  isActive Boolean @default(true)

  // Relations
  gymId         String
  gym           Gym            @relation(fields: [gymId], references: [id], onDelete: Cascade)
  subscriptions Subscription[]
  targetedOpportunities Opportunity[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([gymId])
  @@index([isActive])
}

enum BillingInterval {
  WEEKLY
  MONTHLY
  QUARTERLY
  YEARLY
}

model Subscription {
  id String @id @default(cuid())

  status             SubscriptionStatus
  currentPeriodStart DateTime
  currentPeriodEnd   DateTime
  cancelledAt        DateTime?
  cancelAtPeriodEnd  Boolean            @default(false)
  pausedAt           DateTime?
  resumeAt           DateTime?

  // Stripe
  stripeSubscriptionId String? @unique

  // Relations
  memberId       String @unique
  member         Member @relation(fields: [memberId], references: [id], onDelete: Cascade)
  planId         String
  plan           MembershipPlan @relation(fields: [planId], references: [id])
  failedPayments FailedPaymentAttempt[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([status])
  @@index([currentPeriodEnd])
}

enum SubscriptionStatus {
  ACTIVE
  PAST_DUE
  PAUSED
  CANCELLED
  EXPIRED
}

// ============================================
// CLASSES & SCHEDULING
// ============================================

model Class {
  id String @id @default(cuid())

  name        String
  description String?
  color       String? // For calendar display

  // Capacity
  capacity        Int
  waitlistEnabled Boolean @default(true)
  waitlistMax     Int     @default(10)

  // Duration
  durationMinutes Int

  // Booking rules
  bookingOpensHours    Int @default(168) // 7 days before
  bookingClosesMinutes Int @default(30) // 30 mins before
  cancellationMinutes  Int @default(120) // 2 hours before

  // Credits
  creditsRequired Int @default(1)

  // Status
  isActive Boolean @default(true)

  // Relations
  gymId        String
  gym          Gym    @relation(fields: [gymId], references: [id], onDelete: Cascade)
  instructorId String?
  instructor   Staff? @relation("ClassInstructor", fields: [instructorId], references: [id])

  sessions        ClassSession[]
  recurrenceRules RecurrenceRule[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([gymId])
  @@index([isActive])
}

model RecurrenceRule {
  id String @id @default(cuid())

  // RRULE components
  frequency Frequency
  interval  Int       @default(1)
  byDay     String[] // ["MO", "WE", "FR"]
  startTime String // "09:00"
  startDate DateTime
  endDate   DateTime?

  classId String
  class   Class  @relation(fields: [classId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([classId])
}

enum Frequency {
  DAILY
  WEEKLY
  MONTHLY
}

model ClassSession {
  id String @id @default(cuid())

  startTime DateTime
  endTime   DateTime

  // Override capacity for this session
  capacityOverride Int?

  // Status
  status       SessionStatus @default(SCHEDULED)
  cancelledAt  DateTime?
  cancelReason String?

  // Relations
  classId String
  class   Class  @relation(fields: [classId], references: [id], onDelete: Cascade)
  gymId   String
  gym     Gym    @relation(fields: [gymId], references: [id], onDelete: Cascade)

  bookings Booking[]
  waitlist WaitlistEntry[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([gymId, startTime])
  @@index([classId])
  @@index([status])
}

enum SessionStatus {
  SCHEDULED
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

// ============================================
// BOOKINGS
// ============================================

model Booking {
  id String @id @default(cuid())

  status      BookingStatus @default(CONFIRMED)
  bookedAt    DateTime      @default(now())
  cancelledAt DateTime?
  attendedAt  DateTime? // Marked when checked in

  // Relations
  memberId  String
  member    Member       @relation(fields: [memberId], references: [id], onDelete: Cascade)
  sessionId String
  session   ClassSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([memberId, sessionId])
  @@index([sessionId])
  @@index([status])
}

enum BookingStatus {
  CONFIRMED
  CANCELLED
  NO_SHOW
  ATTENDED
}

model WaitlistEntry {
  id String @id @default(cuid())

  position   Int
  joinedAt   DateTime  @default(now())
  notifiedAt DateTime? // When spot became available
  expiresAt  DateTime? // Deadline to confirm

  // Relations
  memberId  String
  member    Member       @relation(fields: [memberId], references: [id], onDelete: Cascade)
  sessionId String
  session   ClassSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@unique([memberId, sessionId])
  @@index([sessionId, position])
}

// ============================================
// CHECK-INS
// ============================================

model CheckIn {
  id String @id @default(cuid())

  checkedInAt  DateTime      @default(now())
  checkedOutAt DateTime?
  method       CheckInMethod
  notes        String?

  // Pass-based check-in
  creditsUsed  Int           @default(0)
  isOverride   Boolean       @default(false)
  overrideBy   String?

  // Relations
  memberId     String
  member       Member      @relation(fields: [memberId], references: [id], onDelete: Cascade)
  gymId        String
  gym          Gym         @relation(fields: [gymId], references: [id], onDelete: Cascade)
  memberPassId String?
  memberPass   MemberPass? @relation(fields: [memberPassId], references: [id])

  @@index([gymId, checkedInAt])
  @@index([memberId])
  @@index([memberPassId])
}

enum CheckInMethod {
  QR_CODE
  MANUAL
  CARD_SCAN
}

// ============================================
// PAYMENTS & ACCOUNTING
// ============================================

enum PaymentStatus {
  PENDING
  COMPLETED
  FAILED
  REFUNDED
}

enum PaymentMethod {
  CARD
  CASH
  BANK_TRANSFER
  OTHER
}

enum InvoiceStatus {
  DRAFT
  SENT
  PAID
  OVERDUE
  CANCELLED
}

enum ExpenseCategory {
  RENT
  UTILITIES
  EQUIPMENT
  MAINTENANCE
  MARKETING
  PAYROLL
  SUPPLIES
  INSURANCE
  OTHER
}

model Payment {
  id              String        @id @default(cuid())
  amount          Decimal       @db.Decimal(10, 2)
  status          PaymentStatus @default(PENDING)
  method          PaymentMethod
  description     String?
  stripePaymentId String?

  // Relations
  memberId  String?
  member    Member?  @relation(fields: [memberId], references: [id])
  invoiceId String?
  invoice   Invoice? @relation(fields: [invoiceId], references: [id])
  gymId     String
  gym       Gym      @relation(fields: [gymId], references: [id], onDelete: Cascade)
  refunds   Refund[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([gymId])
  @@index([memberId])
  @@index([status])
}

model Invoice {
  id            String        @id @default(cuid())
  invoiceNumber String
  status        InvoiceStatus @default(DRAFT)
  dueDate       DateTime
  subtotal      Decimal       @db.Decimal(10, 2)
  tax           Decimal       @db.Decimal(10, 2) @default(0)
  total         Decimal       @db.Decimal(10, 2)
  notes         String?

  // Canadian Tax Breakdown
  gstAmount     Decimal       @db.Decimal(10, 2) @default(0)
  pstAmount     Decimal       @db.Decimal(10, 2) @default(0)
  hstAmount     Decimal       @db.Decimal(10, 2) @default(0)
  qstAmount     Decimal       @db.Decimal(10, 2) @default(0)
  taxTotal      Decimal       @db.Decimal(10, 2) @default(0)

  // Currency
  currency      String        @default("CAD")
  exchangeRate  Decimal?      @db.Decimal(10, 6) // Rate to base currency

  // Tax Info Snapshot (for audit)
  taxProvince   String?
  taxType       String?       // HST, GST_PST, GST_QST, GST_ONLY
  gstHstNumber  String?       // Snapshot at invoice time

  // Relations
  memberId String
  member   Member        @relation(fields: [memberId], references: [id])
  items    InvoiceItem[]
  payments Payment[]
  gymId    String
  gym      Gym           @relation(fields: [gymId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([gymId, invoiceNumber])
  @@index([gymId])
  @@index([memberId])
  @@index([status])
}

model InvoiceItem {
  id          String  @id @default(cuid())
  description String
  quantity    Int     @default(1)
  unitPrice   Decimal @db.Decimal(10, 2)
  total       Decimal @db.Decimal(10, 2)

  // Relations
  invoiceId String
  invoice   Invoice @relation(fields: [invoiceId], references: [id], onDelete: Cascade)

  @@index([invoiceId])
}

model Expense {
  id          String          @id @default(cuid())
  amount      Decimal         @db.Decimal(10, 2)
  category    ExpenseCategory
  description String
  vendor      String?
  date        DateTime
  receiptUrl  String?

  // Input Tax Credits (ITC) - Canadian Tax Recovery
  gstItc      Decimal?        @db.Decimal(10, 2) // GST paid (claimable)
  pstPaid     Decimal?        @db.Decimal(10, 2) // PST paid (not claimable)
  hstItc      Decimal?        @db.Decimal(10, 2) // HST paid (claimable)
  qstItc      Decimal?        @db.Decimal(10, 2) // QST paid (claimable in QC)

  // Currency
  currency    String          @default("CAD")
  exchangeRate Decimal?       @db.Decimal(10, 6)

  // Relations
  staffId String?
  staff   Staff?  @relation(fields: [staffId], references: [id])
  gymId   String
  gym     Gym     @relation(fields: [gymId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([gymId])
  @@index([category])
  @@index([date])
}

enum PayoutStatus {
  PENDING
  PROCESSING
  PAID
  FAILED
  CANCELLED
}

model Payout {
  id              String       @id @default(cuid())
  amount          Decimal      @db.Decimal(10, 2)
  status          PayoutStatus @default(PENDING)
  description     String?
  stripePayoutId  String?
  stripeAccountId String?      // Connected account ID for instructor payouts

  // Recipient info
  recipientType   String       @default("gym") // "gym", "instructor"
  recipientId     String?      // Staff ID if instructor payout

  // Timing
  scheduledAt     DateTime?
  processedAt     DateTime?

  // Relations
  gymId   String
  gym     Gym    @relation(fields: [gymId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([gymId])
  @@index([status])
  @@index([recipientType])
  @@index([processedAt])
}

// ============================================
// TAGS & SEGMENTATION
// ============================================

model Tag {
  id          String   @id @default(cuid())
  name        String
  color       String   @default("#6366f1")
  description String?
  isSystem    Boolean  @default(false)

  // Relations
  gymId   String
  gym     Gym         @relation(fields: [gymId], references: [id], onDelete: Cascade)
  members MemberTag[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([gymId, name])
  @@index([gymId])
}

model MemberTag {
  id        String   @id @default(cuid())
  appliedAt DateTime @default(now())
  appliedBy String?

  // Relations
  memberId String
  member   Member @relation(fields: [memberId], references: [id], onDelete: Cascade)
  tagId    String
  tag      Tag    @relation(fields: [tagId], references: [id], onDelete: Cascade)

  @@unique([memberId, tagId])
  @@index([memberId])
  @@index([tagId])
}

// ============================================
// AUTOMATED FLOWS
// ============================================

enum FlowTriggerType {
  NO_CHECKIN          // Member hasn't checked in for X days
  MEMBERSHIP_EXPIRING // Membership expiring in X days
  NEW_SIGNUP          // New member signed up
  BIRTHDAY            // Member's birthday
  CUSTOM              // Custom trigger
}

enum FlowActionType {
  SEND_EMAIL
  SEND_SMS
  WAIT
  ADD_TAG
  REMOVE_TAG
}

enum FlowChannel {
  EMAIL
  SMS
  PUSH
}

model AutomatedFlow {
  id          String            @id @default(cuid())
  name        String
  description String?
  triggerType FlowTriggerType
  triggerValue Int?             // e.g., 14 for "14 days"
  isActive    Boolean           @default(false)
  isTemplate  Boolean           @default(false)

  // Relations
  gymId   String
  gym     Gym          @relation(fields: [gymId], references: [id], onDelete: Cascade)
  steps   FlowStep[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([gymId])
  @@index([isActive])
}

model FlowStep {
  id          String         @id @default(cuid())
  order       Int            // Step order in the flow
  actionType  FlowActionType
  channel     FlowChannel?   // For SEND_EMAIL, SEND_SMS
  subject     String?        // Email subject
  content     String?        // Email/SMS content
  waitDays    Int?           // For WAIT action
  tagId       String?        // For ADD_TAG, REMOVE_TAG

  // Relations
  flowId String
  flow   AutomatedFlow @relation(fields: [flowId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([flowId])
}

// ============================================
// CAMPAIGNS
// ============================================

enum CampaignType {
  EMAIL
  SMS
}

enum CampaignStatus {
  DRAFT
  SCHEDULED
  SENDING
  SENT
  PAUSED
  CANCELLED
}

model Campaign {
  id          String         @id @default(cuid())
  name        String
  type        CampaignType
  status      CampaignStatus @default(DRAFT)

  // Content
  subject     String?        // For email campaigns
  content     String         @db.Text

  // Targeting
  targetAudience String      @default("all") // "all", "active", "inactive", "tag:tagId"
  targetTagId    String?     // If targeting a specific tag

  // Scheduling
  scheduledAt DateTime?
  sentAt      DateTime?

  // Stats
  recipientCount Int         @default(0)
  sentCount      Int         @default(0)
  deliveredCount Int         @default(0)
  openedCount    Int         @default(0)
  clickedCount   Int         @default(0)
  bouncedCount   Int         @default(0)

  // Relations
  gymId   String
  gym     Gym    @relation(fields: [gymId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([gymId])
  @@index([type])
  @@index([status])
  @@index([createdAt])
}

// ============================================
// REFUNDS
// ============================================

model Refund {
  id             String   @id @default(cuid())
  amount         Decimal  @db.Decimal(10, 2)
  reason         String?
  status         RefundStatus @default(PENDING)
  stripeRefundId String?
  processedAt    DateTime?

  // Relations
  gymId          String
  gym            Gym      @relation(fields: [gymId], references: [id], onDelete: Cascade)
  paymentId      String
  payment        Payment  @relation(fields: [paymentId], references: [id])
  processedById  String?
  processedBy    Staff?   @relation(fields: [processedById], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([gymId])
  @@index([paymentId])
  @@index([status])
}

enum RefundStatus {
  PENDING
  SUCCEEDED
  FAILED
}

// ============================================
// PRODUCTS (One-time purchases: PT sessions, class packs, merchandise)
// ============================================

enum ProductType {
  PT_SESSION
  CLASS_PACK
  MERCHANDISE
  DROP_IN
  OTHER
}

model Product {
  id              String      @id @default(cuid())
  name            String
  description     String?
  priceAmount     Decimal     @db.Decimal(10, 2)
  type            ProductType
  isActive        Boolean     @default(true)

  // Stripe
  stripePriceId   String?
  stripeProductId String?

  // For class packs
  classCredits    Int?
  validityDays    Int?          // Days pass is valid after activation (null = no expiry)

  // Relations
  gymId     String
  gym       Gym        @relation(fields: [gymId], references: [id], onDelete: Cascade)
  purchases Purchase[]
  passes    MemberPass[] @relation("PassProduct")
  targetedOpportunities Opportunity[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([gymId])
  @@index([type])
  @@index([isActive])
}

model Purchase {
  id              String         @id @default(cuid())
  quantity        Int            @default(1)
  unitPrice       Decimal        @db.Decimal(10, 2)
  totalAmount     Decimal        @db.Decimal(10, 2)
  status          PurchaseStatus @default(PENDING)
  stripePaymentId String?

  // Relations
  gymId      String
  gym        Gym         @relation(fields: [gymId], references: [id], onDelete: Cascade)
  memberId   String
  member     Member      @relation(fields: [memberId], references: [id])
  productId  String
  product    Product     @relation(fields: [productId], references: [id])
  memberPass MemberPass?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([gymId])
  @@index([memberId])
  @@index([status])
}

enum PurchaseStatus {
  PENDING
  COMPLETED
  REFUNDED
  CANCELLED
}

// ============================================
// FAILED PAYMENT TRACKING (Dunning)
// ============================================

model FailedPaymentAttempt {
  id               String              @id @default(cuid())
  amount           Decimal             @db.Decimal(10, 2)
  failureCode      String?
  failureMessage   String?
  attemptNumber    Int                 @default(1)
  nextRetryAt      DateTime?
  status           FailedPaymentStatus @default(PENDING)
  stripeInvoiceId  String?

  // Relations
  gymId          String
  gym            Gym          @relation(fields: [gymId], references: [id], onDelete: Cascade)
  memberId       String
  member         Member       @relation(fields: [memberId], references: [id])
  subscriptionId String
  subscription   Subscription @relation(fields: [subscriptionId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([gymId])
  @@index([memberId])
  @@index([status])
  @@index([nextRetryAt])
}

enum FailedPaymentStatus {
  PENDING
  RECOVERED
  FAILED_FINAL
  WRITTEN_OFF
}

// ============================================
// PAYROLL
// ============================================

model PayrollPeriod {
  id          String        @id @default(cuid())
  startDate   DateTime
  endDate     DateTime
  status      PayrollStatus @default(DRAFT)
  totalAmount Decimal       @db.Decimal(10, 2) @default(0)
  paidAt      DateTime?

  // Relations
  gymId   String
  gym     Gym            @relation(fields: [gymId], references: [id], onDelete: Cascade)
  entries PayrollEntry[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([gymId])
  @@index([status])
  @@index([startDate, endDate])
}

enum PayrollStatus {
  DRAFT
  APPROVED
  PROCESSING
  PAID
  FAILED
}

model PayrollEntry {
  id                String    @id @default(cuid())
  baseAmount        Decimal   @db.Decimal(10, 2) @default(0)
  commissionsAmount Decimal   @db.Decimal(10, 2) @default(0)
  bonusAmount       Decimal   @db.Decimal(10, 2) @default(0)
  deductionsAmount  Decimal   @db.Decimal(10, 2) @default(0)
  totalAmount       Decimal   @db.Decimal(10, 2)
  stripeTransferId  String?
  paidAt            DateTime?
  notes             String?

  // Relations
  payrollPeriodId String
  payrollPeriod   PayrollPeriod @relation(fields: [payrollPeriodId], references: [id], onDelete: Cascade)
  staffId         String
  staff           Staff         @relation(fields: [staffId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([payrollPeriodId])
  @@index([staffId])
}

// ============================================
// GYM PERSONALIZATION
// ============================================

model OpeningHours {
  id          String   @id @default(cuid())
  dayOfWeek   Int      // 0=Sunday, 1=Monday, ... 6=Saturday
  openTime    String?  // "06:00" format, null if closed
  closeTime   String?  // "22:00" format
  isClosed    Boolean  @default(false)

  // Relations
  gymId String
  gym   Gym    @relation(fields: [gymId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([gymId, dayOfWeek])
  @@index([gymId])
}

model GymPolicy {
  id        String  @id @default(cuid())
  type      String  // "rules", "cancellation", "terms", "privacy"
  title     String
  content   String  @db.Text
  isActive  Boolean @default(true)
  sortOrder Int     @default(0)

  // Relations
  gymId String
  gym   Gym    @relation(fields: [gymId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([gymId])
  @@index([type])
}

// ============================================
// CANADIAN ACCOUNTING COMPLIANCE
// ============================================

model TaxConfiguration {
  id              String   @id @default(cuid())
  gymId           String   @unique
  gym             Gym      @relation(fields: [gymId], references: [id], onDelete: Cascade)

  // Tax Registration
  gstHstNumber    String?  // GST/HST Registration Number (e.g., 123456789RT0001)
  pstNumber       String?  // Provincial Sales Tax Number (BC, SK, MB)
  qstNumber       String?  // Quebec Sales Tax Number

  // Tax Rates
  province        String   // Province code (ON, BC, AB, QC, etc.)
  taxType         String   // HST, GST_PST, GST_QST, GST_ONLY
  gstRate         Decimal  @db.Decimal(5, 4) @default(0.05)
  pstRate         Decimal  @db.Decimal(5, 4) @default(0)
  hstRate         Decimal  @db.Decimal(5, 4) @default(0)
  qstRate         Decimal  @db.Decimal(5, 4) @default(0)

  // Small Supplier Status
  isSmallSupplier Boolean  @default(false) // Under $30K annual revenue

  isActive        Boolean  @default(true)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([gymId])
}

model BusinessInfo {
  id                      String   @id @default(cuid())
  gymId                   String   @unique
  gym                     Gym      @relation(fields: [gymId], references: [id], onDelete: Cascade)

  // Legal Entity
  legalName               String   // Legal business name
  businessNumber          String?  // CRA Business Number (9 digits)
  corporationNumber       String?  // Federal/Provincial corp number
  businessType            String   // SOLE_PROPRIETOR, PARTNERSHIP, CORPORATION

  // Registered Address (for invoices)
  streetAddress           String
  city                    String
  province                String
  postalCode              String
  country                 String   @default("CA")

  // Contact for Business
  businessPhone           String?
  businessEmail           String?

  // Provincial Registrations
  provincialRegistrations Json?    // { "ON": "12345", "BC": "67890" }

  createdAt               DateTime @default(now())
  updatedAt               DateTime @updatedAt

  @@index([gymId])
}

model CurrencySettings {
  id                String    @id @default(cuid())
  gymId             String    @unique
  gym               Gym       @relation(fields: [gymId], references: [id], onDelete: Cascade)

  baseCurrency      String    @default("CAD") // Primary currency
  enabledCurrencies String[]  @default(["CAD"]) // ["CAD", "USD", "EUR"]

  // Manual Exchange Rates (if not using live rates)
  usdToCad          Decimal?  @db.Decimal(10, 6)
  eurToCad          Decimal?  @db.Decimal(10, 6)

  useAutoRates      Boolean   @default(false) // Use live exchange rates
  lastRateUpdate    DateTime?

  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  @@index([gymId])
}

// ============================================
// OPPORTUNITIES (Upsell Detection)
// ============================================

enum OpportunityType {
  UPGRADE           // Member on lower plan with high attendance
  PERSONAL_TRAINING // Active member who hasn't tried PT
  RENEWAL           // Subscription expiring soon
  ADDON             // Class packs, merchandise
  CROSS_SELL        // Additional services
}

enum OpportunityStatus {
  NEW
  CONTACTED
  FOLLOW_UP
  WON
  LOST
  DISMISSED
  EXPIRED
}

enum OpportunityConfidence {
  HIGH    // 70%+ probability
  MEDIUM  // 40-70%
  LOW     // <40%
}

model Opportunity {
  id                  String                @id @default(cuid())
  type                OpportunityType
  status              OpportunityStatus     @default(NEW)
  confidence          OpportunityConfidence

  // Core data
  title               String
  description         String?
  reason              String

  // Financial
  potentialValue      Decimal               @db.Decimal(10, 2)
  actualValue         Decimal?              @db.Decimal(10, 2)

  // Recommendation
  recommendedAction   String
  recommendedProduct  String?

  // Detection metadata
  detectedAt          DateTime              @default(now())
  expiresAt           DateTime?

  // Lifecycle tracking
  contactedAt         DateTime?
  contactedBy         String?
  contactMethod       String?
  contactNotes        String?

  resolvedAt          DateTime?
  resolvedBy          String?
  resolutionNotes     String?

  // Scoring factors (for ML optimization)
  scoringFactors      Json?

  // Relations
  memberId            String
  member              Member                @relation(fields: [memberId], references: [id], onDelete: Cascade)
  gymId               String
  gym                 Gym                   @relation(fields: [gymId], references: [id], onDelete: Cascade)
  targetPlanId        String?
  targetPlan          MembershipPlan?       @relation(fields: [targetPlanId], references: [id])
  targetProductId     String?
  targetProduct       Product?              @relation(fields: [targetProductId], references: [id])

  actions             OpportunityAction[]
  conversion          OpportunityConversion?

  createdAt           DateTime              @default(now())
  updatedAt           DateTime              @updatedAt

  @@index([gymId, status])
  @@index([gymId, type])
  @@index([memberId])
  @@index([detectedAt])
  @@index([expiresAt])
}

model OpportunityAction {
  id              String      @id @default(cuid())
  action          String      // "email_sent", "call_made", "discount_offered"
  notes           String?
  staffId         String?

  // Relations
  opportunityId   String
  opportunity     Opportunity @relation(fields: [opportunityId], references: [id], onDelete: Cascade)

  createdAt       DateTime    @default(now())

  @@index([opportunityId])
}

model OpportunityConversion {
  id              String      @id @default(cuid())
  convertedTo     String      // "subscription", "product", "pt_package"
  subscriptionId  String?
  purchaseId      String?
  revenueAmount   Decimal     @db.Decimal(10, 2)
  revenueType     String      // "one_time", "recurring"
  daysToConvert   Int
  touchPoints     Int

  // Relations
  opportunityId   String      @unique
  opportunity     Opportunity @relation(fields: [opportunityId], references: [id], onDelete: Cascade)

  createdAt       DateTime    @default(now())

  @@index([opportunityId])
}

// ============================================
// MEMBER PASSES & CREDITS
// ============================================

enum MemberPassStatus {
  ACTIVE
  EXPIRED
  DEPLETED
  CANCELLED
}

model MemberPass {
  id               String           @id @default(cuid())
  status           MemberPassStatus @default(ACTIVE)
  creditsTotal     Int
  creditsRemaining Int
  activatedAt      DateTime         @default(now())
  expiresAt        DateTime?
  notes            String?

  // Relations
  memberId   String
  member     Member    @relation(fields: [memberId], references: [id], onDelete: Cascade)
  productId  String
  product    Product   @relation("PassProduct", fields: [productId], references: [id])
  purchaseId String?   @unique
  purchase   Purchase? @relation(fields: [purchaseId], references: [id])
  gymId      String
  gym        Gym       @relation(fields: [gymId], references: [id], onDelete: Cascade)
  checkIns   CheckIn[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([gymId])
  @@index([memberId])
  @@index([status])
  @@index([expiresAt])
}

// ============================================
// BONUS BALANCE
// ============================================

enum BonusBalanceTxnType {
  PASS_PURCHASE
  CLASS_ATTENDED
  PURCHASE_APPLIED
  MANUAL_ADJUSTMENT
  PROMO_BONUS
}

model BonusBalance {
  id             String   @id @default(cuid())
  currentBalance Decimal  @db.Decimal(10, 2) @default(0)

  memberId String @unique
  member   Member @relation(fields: [memberId], references: [id], onDelete: Cascade)
  gymId    String
  gym      Gym    @relation(fields: [gymId], references: [id], onDelete: Cascade)

  updatedAt DateTime @updatedAt

  @@index([gymId])
}

model BonusBalanceTransaction {
  id            String              @id @default(cuid())
  type          BonusBalanceTxnType
  amount        Decimal             @db.Decimal(10, 2)
  balanceAfter  Decimal             @db.Decimal(10, 2)
  referenceType String?
  referenceId   String?
  description   String
  createdBy     String

  memberId String
  member   Member @relation(fields: [memberId], references: [id], onDelete: Cascade)
  gymId    String
  gym      Gym    @relation(fields: [gymId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@index([memberId])
  @@index([gymId])
  @@index([createdAt])
}
