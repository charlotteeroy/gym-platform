generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// MULTI-TENANCY: GYM
// ============================================

model Gym {
  id              String   @id @default(cuid())
  name            String
  slug            String   @unique
  email           String
  phone           String?
  address         String?
  timezone        String   @default("UTC")
  currency        String   @default("USD")
  stripeAccountId String?  @unique
  logoUrl         String?
  settings        Json     @default("{}")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  members         Member[]
  staff           Staff[]
  membershipPlans MembershipPlan[]
  classes         Class[]
  classSessions   ClassSession[]
  checkIns        CheckIn[]
  tags            Tag[]
  payments        Payment[]
  invoices        Invoice[]
  expenses        Expense[]
  automatedFlows  AutomatedFlow[]
  campaigns       Campaign[]

  @@index([slug])
}

// ============================================
// USERS & AUTHENTICATION
// ============================================

model User {
  id            String    @id @default(cuid())
  email         String    @unique
  emailVerified DateTime?
  passwordHash  String

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  member   Member?
  staff    Staff?
  sessions Session[]

  @@index([email])
}

model Session {
  id        String   @id @default(cuid())
  userId    String
  token     String   @unique
  expiresAt DateTime

  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([token])
}

model PasswordResetToken {
  id        String   @id @default(cuid())
  email     String
  token     String   @unique
  expiresAt DateTime

  createdAt DateTime @default(now())

  @@index([email])
  @@index([token])
}

// ============================================
// MEMBERS
// ============================================

model Member {
  id String @id @default(cuid())

  // Profile
  firstName        String
  lastName         String
  email            String
  phone            String?
  dateOfBirth      DateTime?
  avatarUrl        String?
  emergencyContact Json? // { name, phone, relation }
  notes            String?

  // Status
  status   MemberStatus @default(ACTIVE)
  joinedAt DateTime     @default(now())

  // Billing
  stripeCustomerId String? @unique

  // Relations
  userId String @unique
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  gymId  String
  gym    Gym    @relation(fields: [gymId], references: [id], onDelete: Cascade)

  subscription    Subscription?
  bookings        Booking[]
  checkIns        CheckIn[]
  waitlistEntries WaitlistEntry[]
  tags            MemberTag[]
  payments        Payment[]
  invoices        Invoice[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([gymId, email])
  @@index([gymId])
  @@index([status])
}

enum MemberStatus {
  PENDING
  ACTIVE
  PAUSED
  CANCELLED
  EXPIRED
}

// ============================================
// STAFF
// ============================================

model Staff {
  id String @id @default(cuid())

  firstName String
  lastName  String
  email     String
  phone     String?
  role      StaffRole
  avatarUrl String?

  // Employment
  hireDate   DateTime @default(now())
  hourlyRate Decimal? @db.Decimal(10, 2)
  isActive   Boolean  @default(true)

  // Relations
  userId String @unique
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  gymId  String
  gym    Gym    @relation(fields: [gymId], references: [id], onDelete: Cascade)

  instructorClasses Class[] @relation("ClassInstructor")
  expenses          Expense[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([gymId, email])
  @@index([gymId])
  @@index([role])
}

enum StaffRole {
  OWNER
  ADMIN
  MANAGER
  INSTRUCTOR
  FRONT_DESK
}

// ============================================
// MEMBERSHIP PLANS & SUBSCRIPTIONS
// ============================================

model MembershipPlan {
  id String @id @default(cuid())

  name        String
  description String?

  // Pricing
  priceAmount     Decimal         @db.Decimal(10, 2)
  priceCurrency   String          @default("USD")
  billingInterval BillingInterval

  // Features
  classCredits Int?     @default(-1) // -1 = unlimited
  guestPasses  Int      @default(0)
  features     String[] @default([])

  // Stripe
  stripePriceId   String?
  stripeProductId String?

  // Status
  isActive Boolean @default(true)

  // Relations
  gymId         String
  gym           Gym            @relation(fields: [gymId], references: [id], onDelete: Cascade)
  subscriptions Subscription[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([gymId])
  @@index([isActive])
}

enum BillingInterval {
  WEEKLY
  MONTHLY
  QUARTERLY
  YEARLY
}

model Subscription {
  id String @id @default(cuid())

  status             SubscriptionStatus
  currentPeriodStart DateTime
  currentPeriodEnd   DateTime
  cancelledAt        DateTime?
  cancelAtPeriodEnd  Boolean            @default(false)

  // Stripe
  stripeSubscriptionId String? @unique

  // Relations
  memberId String @unique
  member   Member @relation(fields: [memberId], references: [id], onDelete: Cascade)
  planId   String
  plan     MembershipPlan @relation(fields: [planId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([status])
  @@index([currentPeriodEnd])
}

enum SubscriptionStatus {
  ACTIVE
  PAST_DUE
  PAUSED
  CANCELLED
  EXPIRED
}

// ============================================
// CLASSES & SCHEDULING
// ============================================

model Class {
  id String @id @default(cuid())

  name        String
  description String?
  color       String? // For calendar display

  // Capacity
  capacity        Int
  waitlistEnabled Boolean @default(true)
  waitlistMax     Int     @default(10)

  // Duration
  durationMinutes Int

  // Booking rules
  bookingOpensHours    Int @default(168) // 7 days before
  bookingClosesMinutes Int @default(30) // 30 mins before
  cancellationMinutes  Int @default(120) // 2 hours before

  // Credits
  creditsRequired Int @default(1)

  // Status
  isActive Boolean @default(true)

  // Relations
  gymId        String
  gym          Gym    @relation(fields: [gymId], references: [id], onDelete: Cascade)
  instructorId String?
  instructor   Staff? @relation("ClassInstructor", fields: [instructorId], references: [id])

  sessions        ClassSession[]
  recurrenceRules RecurrenceRule[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([gymId])
  @@index([isActive])
}

model RecurrenceRule {
  id String @id @default(cuid())

  // RRULE components
  frequency Frequency
  interval  Int       @default(1)
  byDay     String[] // ["MO", "WE", "FR"]
  startTime String // "09:00"
  startDate DateTime
  endDate   DateTime?

  classId String
  class   Class  @relation(fields: [classId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([classId])
}

enum Frequency {
  DAILY
  WEEKLY
  MONTHLY
}

model ClassSession {
  id String @id @default(cuid())

  startTime DateTime
  endTime   DateTime

  // Override capacity for this session
  capacityOverride Int?

  // Status
  status       SessionStatus @default(SCHEDULED)
  cancelledAt  DateTime?
  cancelReason String?

  // Relations
  classId String
  class   Class  @relation(fields: [classId], references: [id], onDelete: Cascade)
  gymId   String
  gym     Gym    @relation(fields: [gymId], references: [id], onDelete: Cascade)

  bookings Booking[]
  waitlist WaitlistEntry[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([gymId, startTime])
  @@index([classId])
  @@index([status])
}

enum SessionStatus {
  SCHEDULED
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

// ============================================
// BOOKINGS
// ============================================

model Booking {
  id String @id @default(cuid())

  status      BookingStatus @default(CONFIRMED)
  bookedAt    DateTime      @default(now())
  cancelledAt DateTime?
  attendedAt  DateTime? // Marked when checked in

  // Relations
  memberId  String
  member    Member       @relation(fields: [memberId], references: [id], onDelete: Cascade)
  sessionId String
  session   ClassSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([memberId, sessionId])
  @@index([sessionId])
  @@index([status])
}

enum BookingStatus {
  CONFIRMED
  CANCELLED
  NO_SHOW
  ATTENDED
}

model WaitlistEntry {
  id String @id @default(cuid())

  position   Int
  joinedAt   DateTime  @default(now())
  notifiedAt DateTime? // When spot became available
  expiresAt  DateTime? // Deadline to confirm

  // Relations
  memberId  String
  member    Member       @relation(fields: [memberId], references: [id], onDelete: Cascade)
  sessionId String
  session   ClassSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@unique([memberId, sessionId])
  @@index([sessionId, position])
}

// ============================================
// CHECK-INS
// ============================================

model CheckIn {
  id String @id @default(cuid())

  checkedInAt DateTime      @default(now())
  method      CheckInMethod

  // Relations
  memberId String
  member   Member @relation(fields: [memberId], references: [id], onDelete: Cascade)
  gymId    String
  gym      Gym    @relation(fields: [gymId], references: [id], onDelete: Cascade)

  @@index([gymId, checkedInAt])
  @@index([memberId])
}

enum CheckInMethod {
  QR_CODE
  MANUAL
  CARD_SCAN
}

// ============================================
// PAYMENTS & ACCOUNTING
// ============================================

enum PaymentStatus {
  PENDING
  COMPLETED
  FAILED
  REFUNDED
}

enum PaymentMethod {
  CARD
  CASH
  BANK_TRANSFER
  OTHER
}

enum InvoiceStatus {
  DRAFT
  SENT
  PAID
  OVERDUE
  CANCELLED
}

enum ExpenseCategory {
  RENT
  UTILITIES
  EQUIPMENT
  MAINTENANCE
  MARKETING
  PAYROLL
  SUPPLIES
  INSURANCE
  OTHER
}

model Payment {
  id              String        @id @default(cuid())
  amount          Decimal       @db.Decimal(10, 2)
  status          PaymentStatus @default(PENDING)
  method          PaymentMethod
  description     String?
  stripePaymentId String?

  // Relations
  memberId  String?
  member    Member?  @relation(fields: [memberId], references: [id])
  invoiceId String?
  invoice   Invoice? @relation(fields: [invoiceId], references: [id])
  gymId     String
  gym       Gym      @relation(fields: [gymId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([gymId])
  @@index([memberId])
  @@index([status])
}

model Invoice {
  id            String        @id @default(cuid())
  invoiceNumber String
  status        InvoiceStatus @default(DRAFT)
  dueDate       DateTime
  subtotal      Decimal       @db.Decimal(10, 2)
  tax           Decimal       @db.Decimal(10, 2) @default(0)
  total         Decimal       @db.Decimal(10, 2)
  notes         String?

  // Relations
  memberId String
  member   Member        @relation(fields: [memberId], references: [id])
  items    InvoiceItem[]
  payments Payment[]
  gymId    String
  gym      Gym           @relation(fields: [gymId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([gymId, invoiceNumber])
  @@index([gymId])
  @@index([memberId])
  @@index([status])
}

model InvoiceItem {
  id          String  @id @default(cuid())
  description String
  quantity    Int     @default(1)
  unitPrice   Decimal @db.Decimal(10, 2)
  total       Decimal @db.Decimal(10, 2)

  // Relations
  invoiceId String
  invoice   Invoice @relation(fields: [invoiceId], references: [id], onDelete: Cascade)

  @@index([invoiceId])
}

model Expense {
  id          String          @id @default(cuid())
  amount      Decimal         @db.Decimal(10, 2)
  category    ExpenseCategory
  description String
  vendor      String?
  date        DateTime
  receiptUrl  String?

  // Relations
  staffId String?
  staff   Staff?  @relation(fields: [staffId], references: [id])
  gymId   String
  gym     Gym     @relation(fields: [gymId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([gymId])
  @@index([category])
  @@index([date])
}

// ============================================
// TAGS & SEGMENTATION
// ============================================

model Tag {
  id          String   @id @default(cuid())
  name        String
  color       String   @default("#6366f1")
  description String?
  isSystem    Boolean  @default(false)

  // Relations
  gymId   String
  gym     Gym         @relation(fields: [gymId], references: [id], onDelete: Cascade)
  members MemberTag[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([gymId, name])
  @@index([gymId])
}

model MemberTag {
  id        String   @id @default(cuid())
  appliedAt DateTime @default(now())
  appliedBy String?

  // Relations
  memberId String
  member   Member @relation(fields: [memberId], references: [id], onDelete: Cascade)
  tagId    String
  tag      Tag    @relation(fields: [tagId], references: [id], onDelete: Cascade)

  @@unique([memberId, tagId])
  @@index([memberId])
  @@index([tagId])
}

// ============================================
// AUTOMATED FLOWS
// ============================================

enum FlowTriggerType {
  NO_CHECKIN          // Member hasn't checked in for X days
  MEMBERSHIP_EXPIRING // Membership expiring in X days
  NEW_SIGNUP          // New member signed up
  BIRTHDAY            // Member's birthday
  CUSTOM              // Custom trigger
}

enum FlowActionType {
  SEND_EMAIL
  SEND_SMS
  WAIT
  ADD_TAG
  REMOVE_TAG
}

enum FlowChannel {
  EMAIL
  SMS
  PUSH
}

model AutomatedFlow {
  id          String            @id @default(cuid())
  name        String
  description String?
  triggerType FlowTriggerType
  triggerValue Int?             // e.g., 14 for "14 days"
  isActive    Boolean           @default(false)
  isTemplate  Boolean           @default(false)

  // Relations
  gymId   String
  gym     Gym          @relation(fields: [gymId], references: [id], onDelete: Cascade)
  steps   FlowStep[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([gymId])
  @@index([isActive])
}

model FlowStep {
  id          String         @id @default(cuid())
  order       Int            // Step order in the flow
  actionType  FlowActionType
  channel     FlowChannel?   // For SEND_EMAIL, SEND_SMS
  subject     String?        // Email subject
  content     String?        // Email/SMS content
  waitDays    Int?           // For WAIT action
  tagId       String?        // For ADD_TAG, REMOVE_TAG

  // Relations
  flowId String
  flow   AutomatedFlow @relation(fields: [flowId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([flowId])
}

// ============================================
// CAMPAIGNS
// ============================================

enum CampaignType {
  EMAIL
  SMS
}

enum CampaignStatus {
  DRAFT
  SCHEDULED
  SENDING
  SENT
  PAUSED
  CANCELLED
}

model Campaign {
  id          String         @id @default(cuid())
  name        String
  type        CampaignType
  status      CampaignStatus @default(DRAFT)

  // Content
  subject     String?        // For email campaigns
  content     String         @db.Text

  // Targeting
  targetAudience String      @default("all") // "all", "active", "inactive", "tag:tagId"
  targetTagId    String?     // If targeting a specific tag

  // Scheduling
  scheduledAt DateTime?
  sentAt      DateTime?

  // Stats
  recipientCount Int         @default(0)
  sentCount      Int         @default(0)
  deliveredCount Int         @default(0)
  openedCount    Int         @default(0)
  clickedCount   Int         @default(0)
  bouncedCount   Int         @default(0)

  // Relations
  gymId   String
  gym     Gym    @relation(fields: [gymId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([gymId])
  @@index([type])
  @@index([status])
  @@index([createdAt])
}
